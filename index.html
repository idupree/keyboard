<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>human input device</title>
<link rel="icon" type="image/png" href="data:image/png;base64,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">
<style>
/* CSS reset */
article,aside,figure,footer,header,hgroup,menu,nav,section{display:block;}
html,body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,code,form,fieldset,legend,input,button,textarea,select,p,blockquote,th,td{margin:0;padding:0;border:0}
h1,h2,h3,h4,h5,h6{font-size:100%;font-weight:inherit;}
img{color:transparent;font-size:0;border:0;vertical-align:middle;}
abbr[title]{border-bottom:dotted 1px;}
button{font:inherit;line-height:inherit;text-align:inherit;text-decoration:none;text-indent:0}

html, body {
  overflow: hidden;
  width: 100%;
  height: 100%;
}
.kb {
  width: 1280px;
  height: 689px;
  background-color: #fcd;
  margin: auto;
}
.row {
  height: 55px;
  width: 100%;
  padding: 5px 0;
  overflow: hidden;
  white-space: nowrap; /* so overflows by a pixel don't wrap */
}
.key {
  display: inline-block;
  min-width: 7.421875%;
  margin: 0 0.391%;
  height: 100%;
  font-size: 24px;
  color: #222;
  background-color: #f9f9f9;
  text-align: center;
  vertical-align: middle;
  text-decoration: none;
  border-radius: 5px;
  cursor: pointer;
  transition: opacity 0.001s; /* for JS :active-change event */
}
.key:active {
  background-color: #aaa;
  opacity: 0.9999999; /* for JS :active-change event */
}
.key[data-action="space"] {
  width: 61.25%;
}
.key[data-action="q"] {
  width: 8.2%;
}
.key[data-action="a"] {
  width: 11.33%;
}
.key[data-action="Left"], .key[data-action="Down"], .key[data-action="Right"], .key[data-action="Up"] {
  width: 5.8594%;
  min-width: initial;
}
.key[data-action="1"], .key[data-action="2"], .key[data-action="3"], .key[data-action="4"],
.key[data-action="5"], .key[data-action="6"], .key[data-action="7"], .key[data-action="8"],
.key[data-action="9"], .key[data-action="0"]
{
  width: 5.8594%;
  min-width: initial;
}
.key[data-action=","], .key[data-action="."], .key[data-action="."] + .key[data-action="/"]
{
  min-width: 5.7032%;
}
</style>
<body>
<script>
+function(){
"use strict";
var rows = [
  ['F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12'],
  ['Esc', 'back', 'forward', 'reload', 'cut', 'copy', 'paste', 'undo', 'redo', 'click', 'm.click', 'r.click'],
  ['?', '{', '}', '[', ']', '/', '\\', '|', '<', '>', ':', '"'],
  ['!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '_', '+'],
  ['`', '=', 'Home', 'End', 'PgUp', 'PgDn', 'Delete'],
  ['Tab', '1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-', 'Delete'],
  ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'Enter'],
  ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ';', '\''],
  ['Shift', 'z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', '/', 'Up', 'Shift'],
  ['Ctrl', 'Alt', 'space', 'Left', 'Down', 'Right']
  ];

// keyname: true for keys that are currently pressed down
var activatedKeys = {};

var cachebuster = function() {
  return '' + Date.now() + Math.random();
}

var $statusarea = document.createElement('div');
$statusarea.className = 'statusarea';

// TODO if queued things are too old, stop trying them
// TODO server-side, unpress keys when connection issues
// TODO: per queue-item padding to equal size, and random dummy packets?
var queue = [];
var inflight_queue = null;

var logStr = 'begin';
$statusarea.textContent = logStr;
var doLog = function(s) {
  logStr += '; ' + s;
  logStr = logStr.slice(-100);
  $statusarea.textContent = logStr;
};

// For sending data over the wire and making it a bit harder for
// eavesdroppers to guess what you sent, make the messages only
// have a few possible size categories they can be.
var jsonStringifyWithPadding = function(obj, padCoarseness) {
  var out = JSON.stringify(obj);
  var padding = ((padCoarseness - 1) - (out.length % padCoarseness));
  return out + ' '.repeat(padding);
};


var retrySendQueue = function() {
  setTimeout(function() {
    queue = [].concat(inflight_queue, queue);
    inflight_queue = null;
    trySendQueue();
  }, 1250);
};
var trySendQueue = function() {
  if(queue.length === 0) {
    return;
  }
  if(inflight_queue) {
    return;
  }
  var startTime = Date.now();
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if(req.readyState === 4) { // complete
      if(req.status === 200 || req.status === 204) {
        console.log("yay");
        inflight_queue = null;
        var endTime = Date.now();
        doLog('done ' + (endTime - startTime) + 'ms.');
        trySendQueue();
      } else {
        console.log("boo!", req.status);
        doLog('failed.');
      }
    }
  };
  req.error = function() {
    doLog('err-retry.');
    retrySendQueue();
  };
  req.timeout = 6000;
  req.ontimeout = function() {
    doLog('timeout-retry.');
    retrySendQueue();
  };
  req.open('POST', '/magic?'+cachebuster(), true);
  req.setRequestHeader('X-Not-Cross-Domain', 'yes');
  //req.setRequestHeader('X-Token', localStorage["authtoken"]);
  //req.setRequestHeader('X-Command', command);
  req.setRequestHeader('Content-Type', 'application/json');
  var body = {"InputEvents": queue};
  inflight_queue = queue;
  queue = [];
  req.send(jsonStringifyWithPadding(body, 120));
};

//..hmm what if keyup gets there before keydown..

// mouseup can be on the wrong element and doesn't work with touch
// simpler: hackily use the transitionend event to detect CSS's
// perfect :active logic!
// ...not quite perfect. Not for multiple touches at once on ChromeOS.
// Also preventDefault on long touches on ChromeOS is important here
// (stop rightclick menu, which is both the goal and sad).
var keyActiveChange = function(keyElem, keyName, isDown) {
  var wasDown = !!activatedKeys[keyName];
  var isDown = !!isDown;
  if(isDown) {
    activatedKeys[keyName] = true;
  } else {
    delete activatedKeys[keyName];
  }
  if(isDown !== wasDown) {
    var action = (isDown ? 'keydn' : 'keyup');
    var inputEvent = {"Action": action, "Key": keyName};
    //padJSONObjToMultiple(inputEvent, 40);
    queue.push(inputEvent);
    trySendQueue();
    // keyElem.style.color = (isDown ? null : null);
    keyElem.style.backgroundColor = (isDown ? '#aaa' : null);
    doLog(keyName + " " + (isDown ? "down" : "up"));
  }
};
var transitionEvent = function(e) {
  e.preventDefault();
  e.stopPropagation();
  var keyElem = e.target;
  var down = keyElem.matches(':active');
  var key = keyElem.dataset.action;
  keyActiveChange(keyElem, key, down);
};
//TODO events bind to body not a?
var touchEvent = function(e) {
  e.preventDefault();
  e.stopPropagation();
  var touches = e.changedTouches;
  for(var i = 0; i < touches.length; i++) {
    var touch = touches[i];
    var keyElem = touch.target;
    var key = keyElem.dataset.action;
    if(key) {
    if(e.type === 'touchstart') {
      keyActiveChange(keyElem, key, true);
    }
    if(e.type === 'touchend' || e.type === 'touchcancel') {
      keyActiveChange(keyElem, key, false);
    }
    }
  }
};
var $kb = document.createElement('div');
$kb.className = 'kb';
$kb.addEventListener('touchstart', touchEvent);
$kb.addEventListener('touchend', touchEvent);
$kb.addEventListener('touchcancel', touchEvent);
$kb.addEventListener('touchmove', touchEvent);
for(var r = 0; r < rows.length; r++) {
  var row = rows[r];
  var $row = document.createElement('div');
  $row.className = 'row';
  for(var c = 0; c < row.length; c++) {
    var key = row[c];
    var $key = document.createElement('button');
    $key.className = 'key';
    $key.textContent = key;
    $key.dataset.action = key;
    //$key.addEventListener('mousedown', keyDown);
    //$key.addEventListener('mouseup', keyUp);
    //not implemented in Chrome, it seems: $key.addEventListener('transitionstart', transitionStart);
    $key.addEventListener('transitionend', transitionEvent);
    $row.appendChild($key);
  }
  $kb.appendChild($row);
}
document.body.appendChild($kb);

$kb.appendChild($statusarea);

}();
</script>
